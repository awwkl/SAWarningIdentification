GitDiffStart: d9407baa70085b8d816b326e7a13585d3f32c0fd | Sat Nov 1 04:49:56 2008 +0000
diff --git a/contrib/velocity/build.xml b/contrib/velocity/build.xml
index 57c7301..5f453de 100644
--- a/contrib/velocity/build.xml
+++ b/contrib/velocity/build.xml
@@ -61,7 +61,9 @@
 
   <target name="build" depends="compile">
     <solr-jar destfile="src/main/solr/lib/${fullnamever}.jar" basedir="target/classes"
-              manifest="${common.dir}/${dest}/META-INF/MANIFEST.MF" />
+              manifest="${common.dir}/${dest}/META-INF/MANIFEST.MF">
+      <fileset dir="src/main/java" excludes="**/*.java"/>
+    </solr-jar>
   </target>
 
   <target name="compileTests" depends="compile">
diff --git a/contrib/velocity/src/main/java/footer.vm b/contrib/velocity/src/main/java/footer.vm
new file mode 100644
index 0000000..d4b8b44
--- /dev/null
+++ b/contrib/velocity/src/main/java/footer.vm
@@ -0,0 +1,9 @@
+#if($params.getBool("debugQuery",false))
+<pre>
+  request = $request
+
+  response = $response.values
+</pre>
+#end
+
+Generated by <a href="http://wiki.apache.org/solr/VelocityResponseWriter">VelocityResponseWriter</a>
\ No newline at end of file
diff --git a/contrib/velocity/src/main/java/org/apache/solr/request/SolrParamResourceLoader.java b/contrib/velocity/src/main/java/org/apache/solr/request/SolrParamResourceLoader.java
index ecac054..8d3d491 100644
--- a/contrib/velocity/src/main/java/org/apache/solr/request/SolrParamResourceLoader.java
+++ b/contrib/velocity/src/main/java/org/apache/solr/request/SolrParamResourceLoader.java
@@ -30,6 +30,7 @@ import java.util.Iterator;
 public class SolrParamResourceLoader extends ResourceLoader {
   private HashMap<String,String> templates = new HashMap();
   public SolrParamResourceLoader(SolrQueryRequest request) {
+    super();
 
     // TODO: Consider using content streams, but need a template name associated with each stream
     // for now, a custom param convention of template.<name>=<template body> is a nice example
@@ -44,7 +45,6 @@ public class SolrParamResourceLoader extends ResourceLoader {
         templates.put(name.substring(9) + ".vm",params.get(name));
       }
     }
-
   }
 
   public void init(ExtendedProperties extendedProperties) {
diff --git a/contrib/velocity/src/main/java/org/apache/solr/request/SolrVelocityResourceLoader.java b/contrib/velocity/src/main/java/org/apache/solr/request/SolrVelocityResourceLoader.java
new file mode 100644
index 0000000..b485213
--- /dev/null
+++ b/contrib/velocity/src/main/java/org/apache/solr/request/SolrVelocityResourceLoader.java
@@ -0,0 +1,34 @@
+package org.apache.solr.request;
+
+import org.apache.velocity.runtime.resource.loader.ResourceLoader;
+import org.apache.velocity.runtime.resource.Resource;
+import org.apache.velocity.exception.ResourceNotFoundException;
+import org.apache.commons.collections.ExtendedProperties;
+import org.apache.solr.core.SolrResourceLoader;
+
+import java.io.InputStream;
+
+// TODO: the name of this class seems ridiculous
+public class SolrVelocityResourceLoader extends ResourceLoader {
+  private SolrResourceLoader loader;
+
+  public SolrVelocityResourceLoader(SolrResourceLoader loader) {
+    super();
+    this.loader = loader;
+  }
+
+  public void init(ExtendedProperties extendedProperties) {
+  }
+
+  public InputStream getResourceStream(String template_name) throws ResourceNotFoundException {
+    return loader.openResource(template_name);
+  }
+
+  public boolean isSourceModified(Resource resource) {
+    return false;
+  }
+
+  public long getLastModified(Resource resource) {
+    return 0;
+  }
+}
diff --git a/contrib/velocity/src/main/java/org/apache/solr/request/VelocityResponseWriter.java b/contrib/velocity/src/main/java/org/apache/solr/request/VelocityResponseWriter.java
index 1b50c74..ae4d309 100644
--- a/contrib/velocity/src/main/java/org/apache/solr/request/VelocityResponseWriter.java
+++ b/contrib/velocity/src/main/java/org/apache/solr/request/VelocityResponseWriter.java
@@ -49,8 +49,10 @@ public class VelocityResponseWriter implements QueryResponseWriter {
       baseDir = new File(template_root);
     }
     engine.setProperty(VelocityEngine.FILE_RESOURCE_LOADER_PATH, baseDir.getAbsolutePath());
-    engine.setProperty("params.resource.loader.instance",new SolrParamResourceLoader(request));
-    engine.setProperty(VelocityEngine.RESOURCE_LOADER, "params,file");
+    engine.setProperty("params.resource.loader.instance", new SolrParamResourceLoader(request));
+    engine.setProperty("solr.resource.loader.instance",
+        new SolrVelocityResourceLoader(request.getCore().getSolrConfig().getResourceLoader()));
+    engine.setProperty(VelocityEngine.RESOURCE_LOADER, "params,file,solr");
 
     return engine;
   }
diff --git a/contrib/velocity/src/main/solr/conf/velocity/browse.vm b/contrib/velocity/src/main/solr/conf/velocity/browse.vm
index 7cffe96..9c1b4e1 100644
--- a/contrib/velocity/src/main/solr/conf/velocity/browse.vm
+++ b/contrib/velocity/src/main/solr/conf/velocity/browse.vm
@@ -44,19 +44,7 @@
 <div class="pagination">
   <span><span class="results-found">$page.results_found</span> results found in ${response.responseHeader.QTime} ms</span>
 </div>
-#if (${nlResponse.suggestions.size()} > 0)
-<div class="spelling">
-  <span>Did you mean?</span>
-  #foreach ($suggestion in ${nlResponse.suggestions})
-  <a href="${request.requestURL}?q=${suggestion}">${suggestion}</a>#if ($velocityCount < $nlResponse.suggestions.size()),#end
-  #end
-</div>
-#end
-#if (${nlResponse.autoSpell} == true)
-<div class="autoSpell">There were no results for your original query, so we automatically searched a few spelling
-  variants: ${nlResponse.autoSpellQuery}
-</div>
-#end
+
 <div class="results">
   #foreach($id in $doclist.iterator())
     #set($doc = $searcher.doc($id,$response.returnFields))
diff --git a/contrib/velocity/src/main/solr/conf/velocity/footer.vm b/contrib/velocity/src/main/solr/conf/velocity/footer.vm
deleted file mode 100644
index 639a266..0000000
--- a/contrib/velocity/src/main/solr/conf/velocity/footer.vm
+++ /dev/null
@@ -1,10 +0,0 @@
-#if($params.getBool("debugQuery",false))
-<pre>
-  request = $request
-
-  response = $response.values
-</pre>
-#end
-
-Generated using <a href="http://wiki.apache.org/solr/VelocityResponseWriter">VelocityResponseWriter</a>
-

